<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InfraGhost AI - Infrastructure Reality Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .ghost-icon {
        font-size: 2rem;
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .success-message {
        animation: slideIn 0.5s ease-out;
      }
      @keyframes slideIn {
        from {
          transform: translateX(-100%);
        }
        to {
          transform: translateX(0);
        }
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-slate-700 shadow-sm border-b border-slate-600">
      <div class="max-w-4xl mx-auto px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-2">
          <span class="ghost-icon">üëª</span>
          <h1 class="text-2xl font-bold text-white">InfraGhost AI</h1>
        </div>
        <div class="flex gap-4">
          <a
            href="/"
            class="px-4 py-2 text-gray-100 hover:bg-slate-600 rounded-lg transition"
            >Submit Report</a
          >
          <a
            href="/map.html"
            class="px-4 py-2 text-gray-100 hover:bg-slate-600 rounded-lg transition"
            >View Map</a
          >
          <a
            href="/authority.html"
            class="px-4 py-2 text-gray-100 hover:bg-slate-600 rounded-lg transition"
            >Authority Summary</a
          >
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-2xl mx-auto py-12 px-6">
      <!-- Hero Section -->
      <div class="text-center mb-12">
        <h2 class="text-3xl font-bold text-gray-900 mb-3">
          Verify Infrastructure Reality
        </h2>
        <p class="text-lg text-gray-600">
          Help us identify InfraGhosts ‚Äî assets that exist on paper but not in
          reality. Upload photos and feedback to build a truthful map of public
          infrastructure.
        </p>
      </div>

      <!-- Submission Form -->
      <div class="bg-white rounded-lg shadow-md p-8 fade-in">
        <!-- Success Message -->
        <div
          id="successMessage"
          class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg success-message"
        >
          <div class="flex items-start gap-3">
            <span class="text-2xl">‚úÖ</span>
            <div>
              <h3 class="font-semibold text-green-900">Report Submitted!</h3>
              <p class="text-sm text-green-700">
                Our system is analyzing the image. Ghost Score will be available
                in the map view.
              </p>
              <p id="ghostScoreDisplay" class="text-sm font-bold text-green-900 mt-2"></p>
            </div>
          </div>
        </div>

        <!-- Error Message -->
        <div
          id="errorMessage"
          class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg"
        >
          <div class="flex items-start gap-3">
            <span class="text-2xl">‚ùå</span>
            <div>
              <h3 class="font-semibold text-red-900">Error</h3>
              <p id="errorText" class="text-sm text-red-700"></p>
            </div>
          </div>
        </div>

        <form id="reportForm" class="space-y-6">
          <!-- Infrastructure Type -->
          <div>
            <label class="block text-sm font-semibold text-gray-900 mb-3">
              Infrastructure Type *
            </label>
            <select
              id="infraType"
              name="infraType"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">Select infrastructure type</option>
              <option value="water">üö∞ Drinking Water</option>
              <option value="toilet">üöΩ Toilet</option>
              <option value="streetlight">üí° Streetlight</option>
              <option value="ramp">‚ôø Ramp</option>
            </select>
          </div>

          <!-- Image Upload -->
          <div>
            <label class="block text-sm font-semibold text-gray-900 mb-3">
              Upload Photo *
            </label>
            <div
              id="imageDropZone"
              class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 transition"
            >
              <input
                type="file"
                id="imageInput"
                name="image"
                accept="image/*"
                required
                class="hidden"
              />
              <span id="imageLabel" class="text-gray-600">
                üì∏ Click to upload or drag and drop<br />
                <span class="text-xs text-gray-500">JPG, PNG up to 10MB</span>
              </span>
              <img
                id="imagePreview"
                src=""
                alt="Preview"
                class="hidden mt-4 max-h-48 mx-auto rounded"
              />
            </div>
          </div>

          <!-- Feedback -->
          <div>
            <label class="block text-sm font-semibold text-gray-900 mb-3">
              What's the actual condition? (max 100 chars)
            </label>
            <input
              type="text"
              id="comment"
              name="comment"
              maxlength="100"
              placeholder="E.g., Tap installed but no water flow"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <p id="charCount" class="text-xs text-gray-500 mt-1">0/100</p>
          </div>

          <!-- Location Status -->
          <div>
            <label class="block text-sm font-semibold text-gray-900 mb-2">
              Location (Auto-detected)
            </label>
            <div id="locationStatus" class="px-4 py-3 bg-gray-100 rounded-lg text-gray-600">
              üìç Detecting location...
            </div>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            id="submitBtn"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            <span id="btnText">üì§ Submit Infra Report</span>
            <span id="btnLoader" class="hidden">‚è≥</span>
          </button>
        </form>
      </div>

      <!-- Info Section -->
      <div class="mt-12 grid md:grid-cols-3 gap-6">
        <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
          <h3 class="font-semibold text-blue-900 mb-2">üîç What We Check</h3>
          <p class="text-sm text-blue-800">
            Our AI analyzes your photo to verify if infrastructure is actually
            usable, not just present on paper.
          </p>
        </div>
        <div class="bg-purple-50 p-6 rounded-lg border border-purple-200">
          <h3 class="font-semibold text-purple-900 mb-2">üëª Ghost Score</h3>
          <p class="text-sm text-purple-800">
            Score 0-100. High scores mean it's an InfraGhost (exists but
            unusable).
          </p>
        </div>
        <div class="bg-green-50 p-6 rounded-lg border border-green-200">
          <h3 class="font-semibold text-green-900 mb-2">üó∫Ô∏è See the Map</h3>
          <p class="text-sm text-green-800">
            All reports are mapped. Authorities can use the summary for action.
          </p>
        </div>
      </div>
    </div>

    <script>
      let userLocation = { latitude: null, longitude: null };

      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
              };
              document.getElementById("locationStatus").innerHTML =
                `üìç ${userLocation.latitude.toFixed(4)}, ${userLocation.longitude.toFixed(
                  4
                )}`;
            },
            () => {
              document.getElementById("locationStatus").innerHTML =
                "üìç Please enable location access";
            }
          );
        }
      }

      const imageDropZone = document.getElementById("imageDropZone");
      const imageInput = document.getElementById("imageInput");
      const imagePreview = document.getElementById("imagePreview");
      const imageLabel = document.getElementById("imageLabel");

      imageDropZone.addEventListener("click", () => imageInput.click());
      imageDropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        imageDropZone.classList.add("border-blue-500", "bg-blue-50");
      });
      imageDropZone.addEventListener("dragleave", () => {
        imageDropZone.classList.remove("border-blue-500", "bg-blue-50");
      });
      imageDropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        imageDropZone.classList.remove("border-blue-500", "bg-blue-50");
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
          imageInput.files = e.dataTransfer.files;
          previewImage();
        }
      });

      imageInput.addEventListener("change", previewImage);

      function previewImage() {
        const file = imageInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreview.classList.remove("hidden");
            imageLabel.classList.add("hidden");
          };
          reader.readAsDataURL(file);
        }
      }

      document.getElementById("comment").addEventListener("input", (e) => {
        document.getElementById("charCount").textContent =
          `${e.target.value.length}/100`;
      });

      document.getElementById("reportForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const infraType = document.getElementById("infraType").value;
        const comment = document.getElementById("comment").value;
        const imageFile = imageInput.files[0];

        if (!imageFile) {
          showError("Please upload an image");
          return;
        }

        if (!userLocation.latitude) {
          showError("Location access is required");
          return;
        }

        document.getElementById("submitBtn").disabled = true;
        document.getElementById("btnText").classList.add("hidden");
        document.getElementById("btnLoader").classList.remove("hidden");

        try {
          const reader = new FileReader();
          reader.onload = async (event) => {
            const imageBase64 = event.target.result.split(",")[1];

            const response = await fetch("/api/submit-report", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                infra_type: infraType,
                comment: comment || "No comment provided",
                latitude: userLocation.latitude,
                longitude: userLocation.longitude,
                image_base64: event.target.result,
              }),
            });

            const data = await response.json();

            if (response.ok) {
              document.getElementById("successMessage").classList.remove("hidden");
              document.getElementById("ghostScoreDisplay").textContent =
                `Ghost Score: ${data.report.analysis.ghost_score} (${data.report.analysis.ghost_level})`;
              document.getElementById("reportForm").reset();
              imagePreview.classList.add("hidden");
              imageLabel.classList.remove("hidden");
              
              document.getElementById("successMessage").scrollIntoView({
                behavior: "smooth",
              });

              setTimeout(() => {
                document.getElementById("successMessage").classList.add("hidden");
              }, 5000);
            } else {
              showError(data.error || "Failed to submit report");
            }
          };
          reader.readAsDataURL(imageFile);
        } catch (error) {
          showError("Network error: " + error.message);
        } finally {
          document.getElementById("submitBtn").disabled = false;
          document.getElementById("btnText").classList.remove("hidden");
          document.getElementById("btnLoader").classList.add("hidden");
        }
      });

      function showError(message) {
        document.getElementById("errorMessage").classList.remove("hidden");
        document.getElementById("errorText").textContent = message;
        setTimeout(() => {
          document.getElementById("errorMessage").classList.add("hidden");
        }, 5000);
      }

      // Initialize
      getLocation();
    </script>
  </body>
</html>
