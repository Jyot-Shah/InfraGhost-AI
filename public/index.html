<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InfraGhost AI</title>
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/index-styles.css" />
  </head>
  <body>
    <!-- Full Screen Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
      <div class="loading-content fade-in">
        <div class="spinner"></div>
        <h3>üîç Analyzing Infrastructure...</h3>
        <p>Our AI is examining your photo to verify the infrastructure reality. This may take a few moments.</p>
        <div class="loading-dots mt-3">
          <span></span>
          <span></span>
          <script type="module" src="/js/index.js"></script>
        </div>
      </div>
      
      <!-- Map Link (shown after submission) -->
      <div id="mapLinkSection" class="hidden" style="text-align: center; margin-top: 40px;">
        <div class="info-card fade-in" style="max-width: 400px; margin: 0 auto;">
          <h3>üó∫Ô∏è See the Map</h3>
          <p>
            All reports are mapped. View the interactive map to see InfraGhosts in your area.
          </p>
          <a href="/map.html" class="btn btn-primary" style="display: inline-block; margin-top: 16px; text-decoration: none;">
            üìç View Infrastructure Map
          </a>
        </div>
      </div>
    </div>

    <script>
      let userLocation = { latitude: null, longitude: null };

      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
              };
              document.getElementById("locationStatus").innerHTML =
                `üìç Location detected: ${userLocation.latitude.toFixed(4)}, ${userLocation.longitude.toFixed(4)}`;
            },
            () => {
              document.getElementById("locationStatus").innerHTML =
                "‚ö†Ô∏è Please enable location access in your browser";
              document.getElementById("locationStatus").style.borderColor = "var(--warning)";
            }
          );
        }
      }

      const imageDropZone = document.getElementById("imageDropZone");
      const imageInput = document.getElementById("imageInput");
      const imagePreview = document.getElementById("imagePreview");
      const imageLabel = document.getElementById("imageLabel");

      imageDropZone.addEventListener("click", () => imageInput.click());
      
      imageDropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        imageDropZone.classList.add("drop-zone-active");
      });
      
      imageDropZone.addEventListener("dragleave", () => {
        imageDropZone.classList.remove("drop-zone-active");
      });
      
      imageDropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        imageDropZone.classList.remove("drop-zone-active");
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
          imageInput.files = e.dataTransfer.files;
          previewImage();
        }
      });

      imageInput.addEventListener("change", previewImage);

      function previewImage() {
        const file = imageInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreview.classList.remove("hidden");
            imageLabel.classList.add("hidden");
          };
          reader.readAsDataURL(file);
        }
      }

      document.getElementById("comment").addEventListener("input", (e) => {
        const count = e.target.value.length;
        document.getElementById("charCount").textContent = `${count}/100 characters`;
      });

      document.getElementById("reportForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const infraType = document.getElementById("infraType").value;
        const comment = document.getElementById("comment").value;
        const imageFile = imageInput.files[0];

        if (!imageFile) {
          showError("Please upload an image");
          return;
        }

        if (!userLocation.latitude) {
          showError("Location access is required. Please enable location in your browser.");
          return;
        }

        document.getElementById("successMessage").classList.add("hidden");
        document.getElementById("errorMessage").classList.add("hidden");
        
        document.getElementById("loadingOverlay").classList.remove("hidden");
        document.getElementById("submitBtn").disabled = true;

        try {
          const reader = new FileReader();
          reader.onload = async (event) => {
            const imageBase64 = event.target.result;

            const response = await fetch("/api/submit-report", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                infra_type: infraType,
                comment: comment || "No comment provided",
                latitude: userLocation.latitude,
                longitude: userLocation.longitude,
                image_base64: imageBase64,
              }),
            });

            const data = await response.json();

            document.getElementById("loadingOverlay").classList.add("hidden");

            if (response.ok) {
              const analysis = data.report.analysis;
              
              document.getElementById("existsValue").innerHTML = 
                analysis.exists ? '<span style="color: var(--success); font-weight: 600;">‚úì Yes</span>' : 
                '<span style="color: var(--error); font-weight: 600;">‚úó No</span>';
              
              document.getElementById("usableValue").innerHTML = 
                analysis.usable ? '<span style="color: var(--success); font-weight: 600;">‚úì Yes</span>' : 
                '<span style="color: var(--error); font-weight: 600;">‚úó No</span>';
              
              document.getElementById("reasonValue").textContent = analysis.reason;
              document.getElementById("usabilityValue").textContent = analysis.usability_score;
              document.getElementById("ghostScoreValue").textContent = analysis.ghost_score;
              
              const ghostScoreElement = document.getElementById("ghostScoreValue");
              ghostScoreElement.style.color = "";
              if (analysis.ghost_score >= 60) {
                ghostScoreElement.style.color = "var(--error)";
              } else if (analysis.ghost_score > 30) {
                ghostScoreElement.style.color = "var(--warning)";
              } else {
                ghostScoreElement.style.color = "var(--success)";
              }
              
              const ghostLevel = analysis.ghost_level;
              const badgeElement = document.getElementById("ghostLevelValue");
              badgeElement.textContent = ghostLevel;
              
              if (ghostLevel === "InfraGhost") {
                badgeElement.style.background = "var(--error)";
                badgeElement.style.color = "white";
              } else if (ghostLevel === "Partial") {
                badgeElement.style.background = "var(--warning)";
                badgeElement.style.color = "white";
              } else {
                badgeElement.style.background = "var(--success)";
                badgeElement.style.color = "white";
              }
              
              document.getElementById("successMessage").classList.remove("hidden");
              document.getElementById("mapLinkSection").classList.remove("hidden");
              document.getElementById("heroSection").classList.add("hidden");
              document.getElementById("formSection").classList.add("hidden");
              document.getElementById("infoSection").classList.add("hidden");
              document.getElementById("reportForm").reset();
              imagePreview.classList.add("hidden");
              imageLabel.classList.remove("hidden");
              document.getElementById("charCount").textContent = "0/100 characters";
              
              document.getElementById("successMessage").scrollIntoView({
                behavior: "smooth",
                block: "center"
              });
            } else {
              showError(data.error || "Failed to submit report");
            }
          };
          reader.readAsDataURL(imageFile);
        } catch (error) {
          document.getElementById("loadingOverlay").classList.add("hidden");
          showError("Network error: " + error.message);
        } finally {
          document.getElementById("submitBtn").disabled = false;
        }
      });

      document.getElementById("closeSuccess").addEventListener("click", () => {
        document.getElementById("successMessage").classList.add("hidden");
        document.getElementById("mapLinkSection").classList.add("hidden");
        document.getElementById("heroSection").classList.remove("hidden");
        document.getElementById("formSection").classList.remove("hidden");
        document.getElementById("infoSection").classList.remove("hidden");
      });

      function showError(message) {
        document.getElementById("loadingOverlay").classList.add("hidden");
        document.getElementById("errorMessage").classList.remove("hidden");
      }
    </script>
    <script type="module" src="/js/index.js"></script>
  </body>
</html>
