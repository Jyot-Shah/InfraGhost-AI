<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InfraGhost Map - Infrastructure Report Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
      /* Ensure the map uses the available area within the flex container */
      #map {
        position: relative;
        width: 100%;
        height: 100%;
      }
      .mapboxgl-popup-content {
        background: white;
        padding: 16px;
        border-radius: 8px;
        max-width: 300px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
      }
      .popup-title {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 8px;
      }
      .popup-item {
        font-size: 13px;
        margin: 4px 0;
      }
      .ghost-score {
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-top: 8px;
      }
      .ghost-score.high {
        background: #fee;
        color: #c00;
      }
      .ghost-score.medium {
        background: #ffeaa7;
        color: #d63031;
      }
      .ghost-score.low {
        background: #55efc4;
        color: #00b894;
      }
      .sidebar {
        width: 350px;
        height: 100vh;
        overflow-y: auto;
        background: white;
        box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
        z-index: 100;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-slate-700 shadow-sm border-b border-slate-600 fixed w-full z-10">
      <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-2">
          <span style="font-size: 1.5rem">üëª</span>
          <h1 class="text-xl font-bold text-white">InfraGhost AI - Map View</h1>
        </div>
        <div class="flex gap-4">
          <a
            href="/"
            class="px-4 py-2 text-gray-100 hover:bg-slate-600 rounded-lg transition"
            >Submit Report</a
          >
          <a
            href="/map.html"
            class="px-4 py-2 text-gray-100 hover:bg-slate-600 rounded-lg transition"
            >View Map</a
          >
          <a
            href="/authority.html"
            class="px-4 py-2 text-gray-100 hover:bg-slate-600 rounded-lg transition"
            >Authority Summary</a
          >
        </div>
      </div>
    </nav>

    <div class="flex pt-16" style="height: calc(100vh - 64px)">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="p-6 border-b">
          <h2 class="text-xl font-bold text-gray-900 mb-4">üìä Report Summary</h2>
          <div class="space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Total Reports:</span>
              <span id="totalReports" class="font-semibold">0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">üî¥ InfraGhosts:</span>
              <span id="ghostCount" class="font-semibold text-red-600">0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">üü° Partial:</span>
              <span id="partialCount" class="font-semibold text-yellow-600">0</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">üü¢ Functional:</span>
              <span id="functionalCount" class="font-semibold text-green-600">0</span>
            </div>
          </div>
        </div>

        <!-- Reports List -->
        <div id="reportsList" class="p-4">
          <!-- Will be populated by JS -->
        </div>
      </div>

      <!-- Map -->
      <div id="map" class="flex-1"></div>
    </div>

    <script>
      let MAPBOX_TOKEN = "";
      
      async function initializeMap() {
        try {
          const configResponse = await fetch("/api/config");
          const config = await configResponse.json();
          MAPBOX_TOKEN = config.mapboxToken;
          
          if (!MAPBOX_TOKEN) {
            const warning = document.createElement("div");
            warning.className = "absolute top-20 left-1/2 -translate-x-1/2 bg-red-100 text-red-700 px-4 py-2 rounded shadow z-20";
            warning.textContent = "‚ö†Ô∏è Mapbox token missing. Add MAPBOX_TOKEN to .env file. Get free token from mapbox.com";
            document.body.appendChild(warning);
            return;
          }

          mapboxgl.accessToken = MAPBOX_TOKEN;

          const map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/mapbox/light-v11",
            center: [75.5637, 26.8415], // Default center (reports location)
            zoom: 14,
          });

          let reports = [];
          const colors = {
            InfraGhost: "#ef4444",
            Partial: "#eab308",
            Functional: "#22c55e",
          };

          async function loadReports() {
            try {
              const response = await fetch("/api/reports");
              reports = await response.json();
              renderMap();
              updateStats();
              renderSidebar();
            } catch (error) {
              console.error("Error loading reports:", error);
            }
          }

          function renderMap() {
            document.querySelectorAll(".mapboxgl-marker").forEach((el) => el.remove());

            reports.forEach((report) => {
              const ghostLevel = report.analysis.ghost_level;
              const color = colors[ghostLevel] || "#9ca3af";

              const el = document.createElement("div");
              el.className = "marker";
              el.style.backgroundColor = color;
              el.style.width = "30px";
              el.style.height = "30px";
              el.style.borderRadius = "50%";
              el.style.cursor = "pointer";
              el.style.border = "3px solid white";
              el.style.display = "flex";
              el.style.alignItems = "center";
              el.style.justifyContent = "center";
              el.style.fontSize = "18px";
              el.style.fontWeight = "bold";
              el.innerHTML = ghostLevel === "InfraGhost" ? "üëª" : ghostLevel === "Partial" ? "?" : "‚úì";

              const popup = new mapboxgl.Popup({ offset: 25 });
              popup.setHTML(createPopupHTML(report));

              new mapboxgl.Marker(el)
                .setLngLat([report.longitude, report.latitude])
                .setPopup(popup)
                .addTo(map);
            });
          }

          function createPopupHTML(report) {
            const ghostScore = report.analysis.ghost_score;
            const ghostLevel = report.analysis.ghost_level;
            const scoreClass =
              ghostScore >= 60 ? "high" : ghostScore > 30 ? "medium" : "low";

            return `
              <div class="popup-title">
                ${getInfraTypeEmoji(report.infra_type)} ${report.infra_type.toUpperCase()}
              </div>
              <div class="popup-item"><strong>Status:</strong> ${ghostLevel}</div>
              <div class="popup-item"><strong>Comment:</strong> ${report.comment}</div>
              <div class="popup-item"><strong>Analysis:</strong> ${report.analysis.reason}</div>
              <div class="ghost-score ${scoreClass}">
                Ghost Score: ${ghostScore}
              </div>
              <div class="popup-item" style="font-size: 12px; color: #666; margin-top: 8px;">
                üìç ${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}
              </div>
              <div class="popup-item" style="font-size: 12px; color: #999;">
                ${new Date(report.timestamp).toLocaleDateString()}
              </div>
            `;
          }

          function getInfraTypeEmoji(type) {
            const emojis = {
              water: "üö∞",
              toilet: "üöΩ",
              streetlight: "üí°",
              ramp: "‚ôø",
            };
            return emojis[type] || "üìç";
          }

          function updateStats() {
            const ghosts = reports.filter((r) => r.analysis.ghost_score >= 60);
            const partial = reports.filter((r) => r.analysis.ghost_level === "Partial");
            const functional = reports.filter((r) => r.analysis.ghost_level === "Functional");

            document.getElementById("totalReports").textContent = reports.length;
            document.getElementById("ghostCount").textContent = ghosts.length;
            document.getElementById("partialCount").textContent = partial.length;
            document.getElementById("functionalCount").textContent = functional.length;
          }

          function renderSidebar() {
            const listDiv = document.getElementById("reportsList");
            if (reports.length === 0) {
              listDiv.innerHTML =
                '<p class="text-gray-500 text-sm text-center py-8">No reports yet. Submit your first infra report!</p>';
              return;
            }

            const sorted = [...reports].sort(
              (a, b) => b.analysis.ghost_score - a.analysis.ghost_score
            );

        listDiv.innerHTML = sorted
          .map(
            (r, idx) => `
          <div class="mb-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition" 
               onclick="map.flyTo({center: [${r.longitude}, ${r.latitude}], zoom: 14})">
            <div class="flex justify-between items-start">
              <div>
                <div class="font-semibold text-sm">
                  ${getInfraTypeEmoji(r.infra_type)} ${r.infra_type}
                </div>
                <div class="text-xs text-gray-500 mt-1">${r.comment}</div>
              </div>
              <div class="text-right">
                <div class="font-bold text-sm ${
                  r.analysis.ghost_score >= 60
                    ? "text-red-600"
                    : r.analysis.ghost_score > 30
                    ? "text-yellow-600"
                    : "text-green-600"
                }">
                  ${r.analysis.ghost_score}
                </div>
                <div class="text-xs text-gray-500">${r.analysis.ghost_level}</div>
              </div>
            </div>
          </div>
        `
          )
          .join("");
      }

      loadReports();
      setInterval(loadReports, 30000);
    } catch (error) {
      console.error("Error initializing map:", error);
    }
  }
  
  initializeMap();
    </script>
  </body>
</html>
